<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
</head>
<body>
    <h2>Forgot Password</h2>
    <h2>{{ message }}</h2>
    <form action="{% url 'forgot_password' %}"  method="post" id="otp_form">
        {% csrf_token %}
        <label for="email">Enter your email:</label>
        <input type="email" id="email" name="email" required>
        <button type="submit">Send OTP</button>
    </form>

    <div class="hideout" id="otp_container">
    <form action="{% url 'verify_otp' %}" method="post" id="verify_otp_form">
        <h2>{{ error }}</h2>
        {% csrf_token %}
        <input type="hidden" name="email" value="{{ email }}">
        <label for="otp">Enter OTP:</label>
        <input type="text" id="otp" name="otp" required value="{{ stored_otp }}">
        <button type="submit">Verify OTP</button>
    </form>
    </div>

    <br>
    <div class="hideout" id="reset_password_container">
        <form method="POST" action="{% url 'reset_password' %}" id="reset_password">
            {% csrf_token %}
            <input type="hidden" name="email" value="{{ email }}">
            <label for="email">Please Enter your Email:</label>
            <input type="email" id="email" name="email" value="{{ email }}"> 
            <br>
            <label for="new_password">Enter new password:</label>
            <input type="password" id="new_password" name="new_password" required>
            <br>
            <label for="confirm_new_password">Enter confirm password:</label>
            <input type="password" id="confirm_new_password" name="confirm_new_password" required>
            <br>
            <button type="submit">Reset Password</button>
        </form>
    </div>
        <br>

    <div class="hideout"> 
        <h2>Verify OTP</h2>
    <p>An OTP has been sent to your email. Please enter it below:</p>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="email" value="{{ email }}">
        <label for="otp">Enter OTP:</label>
        <input type="text" id="otp" name="otp" required value="{{ error }}">
        <button type="submit">Verify OTP</button>
    </form>
</div>
    <script>
        document.getElementById("verify_otp_form").addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent the form from submitting
            //event.preventDefault();
            // Assuming OTP is correct and you want to unhide the reset password form
            document.getElementById("reset_password_container").classList.remove("hideout");
            // document.getElementById("otp_container").classList.remove("hideout");

            // this.submit();
            // Optionally, you can submit the OTP form via AJAX here if needed
            // this.submit(); // Uncomment this line to allow the form to be submitted
        });
    </script>

<!-- <script>

        document.getElementById("otp_form").addEventListener("submit", function(event) {
            // event.preventDefault(); // Prevent the form from submitting
            document.getElementById("otp_container").classList.remove("hideout");

        });

</script> -->

<script>
    document.getElementById("otp_form").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent the form from submitting
        var formData = new FormData(this);

        fetch("{% url 'forgot_password' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("Redirecting to:", data.redirect_url);
                document.getElementById("otp_container").classList.remove("hideout");
            } else {
                console.error("Error:", data.message);
            }
        })
        .catch(error => console.error("Error:", error));
    });

    document.getElementById("reset_password_form").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent the form from submitting
        var formData = new FormData(this);

        fetch("{% url 'reset_password' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            } ,
            credentials: 'include'  
        })
        .then(response => response.json())
        .then(data => {
            console.log(data)
            if (data.success) {
                window.location.href = data.redirect_url;  // Redirect the user
            } else {
                console.error("Error:", data.message);
            }
        })
        .catch(error => console.error("Error:", error));
    });
</script>

        <!-- <script>
            window.onload = function() {
            var otpGenerated = stored_otp;
            console.log(otpGenerated)
            // var otpGenerated = {{ stored_otp|yesno:"true,false" }};

            if (otpGenerated) {
                document.getElementById("otp_container").classList.remove("hideout");
                // document.querySelector('.hideout').style.display = 'block';
            }
        };
            </script> -->
         

    <style>
        .hideout {
            display: none;
        }
    </style>
    
    <!-- <form action="{% url 'verify_otp' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="email" value="{{ email }}">
        <label for="otp">Enter OTP:</label>
        <input type="text" id="otp" name="otp" required>
        <button type="submit">Verify OTP</button>
    </form>
    <br>
    <div class="hideout" >
        <form method="POST" action="{% url 'reset_password' %}" id="reset_password" >
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit"class="hideout">Reset Password</button>
        </form>
    </div>
     -->
    
    <!-- <form action="{% url 'reset_password' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="email" value="{{ email }}">
        <label for="new_password">Enter new password:</label>
        <input type="password" id="new_password" name="new_password" required>
        <br>
        <label for="confirm_new_password">Enter confirm password:</label>
        <input type="password" id="confirm_new_password" name="confirm_new_password" required>
        <br>
        <label for="email">Enter your email:</label>
        <input type="email" id="email" name="email" required>
        <br>
        <button type="submit">Reset Password</button>
    </form> -->
    <br>

</body>
</html>
